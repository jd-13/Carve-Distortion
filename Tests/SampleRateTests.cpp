/*
  ==============================================================================

    SampleRateTests.cpp
    Created: 15 Nov 2016 8:55:29pm
    Author:  Jack Devlin

  ==============================================================================
*/

#include "PluginProcessor.h"
#include "catch.hpp"
#include "CoreTestLib.h"

SCENARIO("Audio is processed correctly across several standard sample rates") {
    GIVEN("A new CarveAudioProcessor object, sample rate of 44.1kHz, and a 400Hz sine wave") {
        AudioSampleBuffer mSampleBuffer(2, 1024);
        CarveAudioProcessor mProcessor;
        mProcessor.setParameter(CarveAudioProcessor::mode1, 2);
        mProcessor.setParameter(CarveAudioProcessor::routing, 1);
        
        const int sampleRate {44100};

        ToneGeneratorAudioSource sineGenerator;
        sineGenerator.setAmplitude(0.5);
        sineGenerator.setFrequency(400);
        sineGenerator.prepareToPlay(mSampleBuffer.getNumSamples(), sampleRate);
        sineGenerator.getNextAudioBlock(AudioSourceChannelInfo(mSampleBuffer));
        
        float expectedOutput[] {-1.12493e-08, 0.0250704, 0.0779938, 0.118302, 0.157725, 0.199625, 0.232654, 0.268783, 0.297762, 0.32561, 0.350111, 0.370029, 0.388864, 0.402269, 0.41483, 0.423125, 0.429825, 0.434059, 0.436101, 0.437082, 0.435947, 0.434447, 0.431473, 0.428304, 0.424468, 0.420414, 0.416308, 0.411976, 0.407858, 0.403555, 0.399406, 0.395077, 0.390629, 0.385872, 0.38061, 0.374734, 0.367914, 0.360029, 0.350732, 0.339842, 0.32707, 0.312188, 0.294995, 0.275277, 0.252923, 0.227804, 0.199906, 0.169234, 0.135887, 0.100024, 0.0618686, 0.0217248, -0.02006, -0.0630676, -0.106853, -0.150929, -0.194799, -0.237965, -0.279937, -0.32026, -0.358511, -0.394329, -0.427405, -0.457503, -0.484458, -0.508175, -0.528633, -0.545876, -0.560009, -0.571193, -0.579629, -0.585556, -0.589236, -0.590949, -0.590976, -0.589599, -0.587088, -0.583693, -0.579645, -0.575143, -0.570355, -0.565415, -0.560417, -0.555421, -0.550444, -0.545466, -0.540429, -0.535237, -0.52976, -0.523835, -0.517271, -0.509854, -0.501348, -0.491508, -0.480081, -0.466816, -0.451475, -0.433838, -0.413716, -0.390959, -0.365463, -0.337181, -0.306127, -0.272384, -0.236101, -0.197499, -0.156867, -0.114552, -0.0709588, -0.0265349, 0.0182408, 0.0628712, 0.106856, 0.149706, 0.190958, 0.230188, 0.267023, 0.30115, 0.332323, 0.360366, 0.385178, 0.406727, 0.42505, 0.440245, 0.452466, 0.46191, 0.468811, 0.473429, 0.476042, 0.476933, 0.476382, 0.474662, 0.472027, 0.468709, 0.464911, 0.460806, 0.456532, 0.452189, 0.44784, 0.443508, 0.439178, 0.434795, 0.43027, 0.425475, 0.420253, 0.414415, 0.40775, 0.400024, 0.390993, 0.380405, 0.368007, 0.35356, 0.336842, 0.317658, 0.295853, 0.271318, 0.243997, 0.213897, 0.181091, 0.145722, 0.108, 0.0682051, 0.0266798, -0.0161789, -0.0599284, -0.104093, -0.148177, -0.191679, -0.234108, -0.274998, -0.313918, -0.350489, -0.384389, -0.415363, -0.443228, -0.467873, -0.489256, -0.507408, -0.522418, -0.534434, -0.543648, -0.55029, -0.554618, -0.556908, -0.557441, -0.5565, -0.554359, -0.551274, -0.547479, -0.543184, -0.538564, -0.533761, -0.528881, -0.523991, -0.519119, -0.514254, -0.509349, -0.504315, -0.499032, -0.493344, -0.487068, -0.479993, -0.471891, -0.462516, -0.451616, -0.438941, -0.424248, -0.407311, -0.387933, -0.365953, -0.341255, -0.313777, -0.283518, -0.250541, -0.214981, -0.17704, -0.13699, -0.0951652, -0.0519564, -0.00780119, 0.036828, 0.0814373, 0.125526, 0.1686, 0.210189, 0.249858, 0.28722, 0.321947, 0.353774, 0.382509, 0.408031, 0.430292, 0.449312, 0.465175, 0.47802, 0.488036, 0.495447, 0.500509, 0.503496, 0.504689, 0.504372, 0.502819, 0.500289, 0.497021, 0.493225, 0.489083, 0.48474, 0.480307, 0.475856, 0.471421, 0.466994, 0.462533, 0.457955, 0.453143, 0.447945, 0.442182, 0.435647, 0.428111, 0.419332, 0.409059, 0.39704, 0.38303, 0.366802, 0.348154, 0.32692, 0.302978, 0.276259, 0.246753, 0.214518, 0.179676, 0.142423, 0.103021, 0.0617982, 0.019138, -0.0245272, -0.0687285, -0.112974, -0.156762, -0.199599, -0.24101, -0.280554, -0.317838, -0.352525, -0.384344, -0.413093, -0.438642, -0.460933, -0.479979, -0.495856, -0.508696, -0.518681, -0.526035, -0.531008, -0.533872, -0.534909, -0.534402, -0.532627, -0.529845, -0.526298, -0.5222, -0.517737, -0.513058, -0.508279, -0.503477, -0.498689, -0.493915, -0.489116, -0.484213, -0.479094, -0.473612, -0.46759, -0.460824, -0.453089, -0.444143, -0.433736, -0.421616, -0.407536, -0.391267, -0.372603, -0.351372, -0.327448, -0.300754, -0.271273, -0.239052, -0.204207, -0.166925, -0.127458, -0.0861276, -0.0433105, 0.000566453, 0.0450382, 0.0896149, 0.133796, 0.177085, 0.219003, 0.259107, 0.296996, 0.332325, 0.364815, 0.394254, 0.420504, 0.443498, 0.463241, 0.479799, 0.493301, 0.503921, 0.511879, 0.517422, 0.52082, 0.522353, 0.522306, 0.520956, 0.518567, 0.515381, 0.511619, 0.507468, 0.503084, 0.498585, 0.494055, 0.489535, 0.485029, 0.480504, 0.475886, 0.471066, 0.465902, 0.46022, 0.45382, 0.446479, 0.437956, 0.428003, 0.416366, 0.402798, 0.387067, 0.368964, 0.348313, 0.32498, 0.298883, 0.269995, 0.238357, 0.204075, 0.167327, 0.128359, 0.0874816, 0.0450666, 0.00153483, -0.0426528, -0.0870088, -0.131033, -0.174228, -0.216112, -0.256235, -0.294192, -0.329631, -0.362262, -0.391867, -0.418297, -0.441477, -0.461402, -0.478133, -0.491789, -0.502542, -0.510603, -0.516218, -0.519655, -0.521194, -0.521118, -0.519705, -0.517223, -0.513917, -0.510009, -0.505692, -0.501125, -0.496433, -0.491701, -0.486979, -0.482273, -0.477555, -0.472757, -0.467773, -0.462467, -0.456667, -0.450176, -0.442773, -0.434222, -0.424272, -0.412671, -0.399171, -0.383537, -0.365557, -0.34505, -0.321875, -0.295945, -0.267225, -0.235747, -0.20161, -0.164982, -0.1261, -0.0852683, -0.0428502, 0.000738579, 0.0450414, 0.0895734, 0.133835, 0.177328, 0.219568, 0.2601, 0.298513, 0.334447, 0.367605, 0.397759, 0.424751, 0.448498, 0.468987, 0.486268, 0.500456, 0.511716, 0.520254, 0.526314, 0.530159, 0.53207, 0.53233, 0.531219, 0.529003, 0.525934, 0.522236, 0.518105, 0.513705, 0.509166, 0.504577, 0.499992, 0.495424, 0.490849, 0.486203, 0.481386, 0.476264, 0.47067, 0.46441, 0.457267, 0.449004, 0.439373, 0.428122, 0.415001, 0.399773, 0.382223, 0.362166, 0.339455, 0.313996, 0.285747, 0.254732, 0.22104, 0.184831, 0.146335, 0.105845, 0.0637208, 0.0203701, -0.0237546, -0.0681711, -0.112381, -0.155885, -0.198195, -0.238854, -0.277443, -0.313596, -0.347008, -0.37744, -0.404728, -0.428778, -0.449568, -0.467143, -0.481607, -0.493121, -0.501887, -0.508142, -0.512151, -0.514191, -0.514545, -0.513494, -0.511307, -0.508238, -0.504513, -0.500334, -0.495869, -0.49125, -0.486574, -0.481898, -0.47724, -0.472581, -0.467862, -0.462988, -0.457827, -0.452219, -0.445971, -0.438868, -0.430677, -0.42115, -0.410035, -0.397082, -0.382052, -0.364726, -0.344914, -0.322466, -0.297279, -0.269304, -0.238558, -0.205121, -0.169144, -0.130847, -0.0905189, -0.0485078, -0.00521779, 0.0389038, 0.0833779, 0.127707, 0.171392, 0.213942, 0.254896, 0.293828, 0.330365, 0.364195, 0.395072, 0.42282, 0.447337, 0.468592, 0.486622, 0.501524, 0.513453, 0.522605, 0.529216, 0.533545, 0.535868, 0.53647, 0.535632, 0.533625, 0.530703, 0.527099, 0.523016, 0.518627, 0.514069, 0.509443, 0.504811, 0.500197, 0.495586, 0.490923, 0.486118, 0.481045, 0.475544, 0.469429, 0.462486, 0.454484, 0.445178, 0.434314, 0.421642, 0.406922, 0.389931, 0.370475, 0.348398, 0.323592, 0.296001, 0.265631, 0.232556, 0.196918, 0.158929, 0.118868, 0.077076, 0.0339518, -0.0100626, -0.0544913, -0.0988386, -0.142604, -0.185295, -0.226447, -0.265628, -0.302458, -0.336618, -0.367851, -0.395975, -0.420876, -0.442517, -0.460925, -0.476191, -0.488461, -0.497929, -0.504825, -0.509406, -0.511948, -0.512733, -0.512043, -0.510152, -0.507316, -0.503771, -0.499724, -0.495351, -0.490795, -0.486162, -0.481517, -0.47689, -0.47227, -0.467608, -0.462817, -0.457776, -0.45233, -0.446295, -0.439461, -0.431598, -0.422462, -0.411802, -0.399364, -0.384908, -0.368208, -0.349066, -0.327321, -0.302857, -0.275613, -0.245587, -0.212843, -0.177515, -0.139806, -0.0999864, -0.0583915, -0.0154121, 0.0285144, 0.0729155, 0.117297, 0.161159, 0.204007, 0.24537, 0.284814, 0.321952, 0.356455, 0.388059, 0.416572, 0.441873, 0.463913, 0.482712, 0.498355, 0.510981, 0.520778, 0.527972, 0.532817, 0.535587, 0.536564, 0.536031, 0.534263, 0.531519, 0.528038, 0.524029, 0.519674, 0.51512, 0.510477, 0.505815, 0.50117, 0.496534, 0.491865, 0.487079, 0.482059, 0.476655, 0.470686, 0.463946, 0.456205, 0.447222, 0.436745, 0.424523, 0.410311, 0.393881, 0.375032, 0.353598, 0.329456, 0.302538, 0.272834, 0.240401, 0.205362, 0.167912, 0.128314, 0.0868958, 0.0440407, 0.000181273, -0.0442136, -0.088652, -0.132633, -0.175662, -0.217263, -0.256998, -0.294472, -0.329349, -0.361357, -0.390294, -0.41603, -0.438508, -0.45774, -0.473802, -0.486828, -0.496998, -0.504536, -0.509692, -0.512739, -0.513958, -0.513632, -0.512038, -0.509436, -0.506069, -0.502151, -0.497866, -0.493365, -0.488764, -0.484138, -0.479526, -0.474928, -0.470303, -0.465575, -0.46063, -0.455321, -0.449472, -0.442878, -0.435314, -0.426539, -0.416303, -0.404352, -0.390441, -0.374341, -0.355845, -0.334782, -0.311025, -0.284497, -0.255181, -0.223125, -0.188445, -0.151326, -0.112023, -0.0708552, -0.0282002, 0.0155151, 0.0598258, 0.104242, 0.148263, 0.191393, 0.233153, 0.273098, 0.310829, 0.346001, 0.378335, 0.407618, 0.433712, 0.456552, 0.47614, 0.492545, 0.505894, 0.516362, 0.524168, 0.529559, 0.532806, 0.53419, 0.533993, 0.532494, 0.529956, 0.526622, 0.522712, 0.518415, 0.513884, 0.50924, 0.504564, 0.499899, 0.49525, 0.49058, 0.485819, 0.480857, 0.475551, 0.469728, 0.463187, 0.455706, 0.447043, 0.43695, 0.425175, 0.411469, 0.395601, 0.377361, 0.356573, 0.333104, 0.306871, 0.277849, 0.246076, 0.211661, 0.174779, 0.135678, 0.094669, 0.0521223, 0.00845944, -0.0358588, -0.0803448, -0.124499, -0.167822, -0.209835, -0.250086, -0.288171, -0.323736, -0.356494, -0.386224, -0.41278, -0.436085, -0.456134, -0.472989, -0.486768, -0.497643, -0.505827, -0.511564, -0.515122, -0.516781, -0.516825, -0.515532, -0.513169, -0.509981, -0.506192, -0.501992, -0.497543, -0.492967, -0.488351, -0.483744, -0.479153, -0.47455, -0.469865, -0.464995, -0.459802, -0.454114, -0.447735, -0.440444, -0.432004, -0.422164, -0.410673, -0.397283, -0.381758, -0.363886, -0.343487, -0.32042, -0.294596, -0.265983, -0.234611, -0.20058, -0.164056, -0.125279, -0.0845512, -0.0422366, 0.00124907, 0.0454494, 0.0898793, 0.13404, 0.177431, 0.219571, 0.260003, 0.298316, 0.33415, 0.36721, 0.397265, 0.42416, 0.44781, 0.468201, 0.485387, 0.499479, 0.510643, 0.519087, 0.525052, 0.528803, 0.530621, 0.530788, 0.529584, 0.527276, 0.524116, 0.520326, 0.516105, 0.511615, 0.506985, 0.502307, 0.497633, 0.492977, 0.488314, 0.483581, 0.478677, 0.473468, 0.467788, 0.461443, 0.454215, 0.445867, 0.436152, 0.424816, 0.411612, 0.396302, 0.378669, 0.35853, 0.335738, 0.310197, 0.281868, 0.250772, 0.217001, 0.180713, 0.142137, 0.10157, 0.0593669, 0.0159386, -0.0282632, -0.0727564, -0.117043, -0.160622, -0.203008, -0.243742, -0.282406, -0.318633, -0.352118, -0.382623, -0.409984, -0.434107, -0.454969, -0.472615, -0.48715, -0.498735, -0.50757, -0.513896, -0.517974, -0.520083, -0.520505, -0.519522, -0.517404, -0.514401, -0.510744, -0.506631, -0.502232, -0.497679, -0.493068, -0.488457, -0.483864, -0.479269, -0.474613, -0.469802, -0.464704, -0.459158, -0.452972, -0.445931, -0.437801, -0.428335, -0.41728, -0.404387, -0.389417, -0.37215, -0.352397, -0.330007, -0.304877, -0.276961, -0.246272, -0.212891, -0.176971, -0.13873, -0.0984572, -0.0565014, -0.0132661, 0.030801, 0.0752211, 0.119497, 0.163128, 0.205626, 0.246526, 0.285406, 0.321892, 0.355671, 0.386496, 0.414194, 0.43866, 0.459866, 0.477846, 0.4927, 0.504579, 0.513683, 0.520246, 0.524527, 0.526803, 0.527358, 0.526474, 0.52442, 0.521453, 0.517803, 0.513675, 0.509241, 0.504639, 0.499969, 0.495294, 0.490637, 0.485983, 0.481277};
        
        WHEN("The sine wave is processed") {
            mProcessor.prepareToPlay(sampleRate, mSampleBuffer.getNumSamples());
            MidiBuffer mMidiBuffer;
            mProcessor.processBlock(mSampleBuffer, mMidiBuffer);
            THEN("The output is as expected") {
                const float* readPointer1 {mSampleBuffer.getReadPointer(0)};
                const float* readPointer2 {mSampleBuffer.getReadPointer(1)};
                
                for (int iii {}; iii < mSampleBuffer.getNumSamples(); iii++) {
                    REQUIRE(CoreTestLib::compareFloats(readPointer1[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                    REQUIRE(CoreTestLib::compareFloats(readPointer2[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                }
            }
        }
    }
    
    GIVEN("A new CarveAudioProcessor object, sample rate of 48kHz, and a 400Hz sine wave") {
        AudioSampleBuffer mSampleBuffer(2, 1024);
        CarveAudioProcessor mProcessor;
        mProcessor.setParameter(CarveAudioProcessor::mode1, 2);
        mProcessor.setParameter(CarveAudioProcessor::routing, 1);
        
        const int sampleRate {48000};
        
        ToneGeneratorAudioSource sineGenerator;
        sineGenerator.setAmplitude(0.5);
        sineGenerator.setFrequency(400);
        sineGenerator.prepareToPlay(mSampleBuffer.getNumSamples(), sampleRate);
        sineGenerator.getNextAudioBlock(AudioSourceChannelInfo(mSampleBuffer));
        
        float expectedOutput[] {-8.32963e-09, 0.0170635, 0.0627857, 0.105517, 0.138845, 0.178901, 0.21257, 0.24418, 0.275988, 0.301861, 0.327662, 0.349517, 0.368498, 0.385695, 0.399124, 0.410929, 0.419933, 0.42677, 0.431878, 0.434877, 0.436599, 0.436843, 0.435984, 0.434284, 0.431765, 0.428788, 0.425375, 0.421713, 0.417921, 0.414032, 0.410154, 0.406274, 0.402407, 0.398528, 0.394565, 0.390454, 0.386075, 0.381306, 0.375997, 0.369979, 0.363077, 0.355096, 0.345843, 0.335123, 0.322744, 0.308528, 0.292314, 0.273961, 0.253363, 0.230443, 0.205169, 0.177551, 0.147647, 0.115563, 0.081458, 0.0455366, 0.00805044, -0.0307076, -0.0704094, -0.110698, -0.151198, -0.191521, -0.23128, -0.270096, -0.307607, -0.343479, -0.377413, -0.409149, -0.438477, -0.465233, -0.489307, -0.510639, -0.529221, -0.54509, -0.558329, -0.569057, -0.577426, -0.583615, -0.587823, -0.590261, -0.591148, -0.590703, -0.589143, -0.586673, -0.583486, -0.579758, -0.575643, -0.571273, -0.566756, -0.562173, -0.557578, -0.552997, -0.548428, -0.543843, -0.539186, -0.534374, -0.529301, -0.523838, -0.517837, -0.51113, -0.503539, -0.494872, -0.484935, -0.473532, -0.460473, -0.445578, -0.428687, -0.40966, -0.388388, -0.364798, -0.338854, -0.310569, -0.279999, -0.247251, -0.212484, -0.175903, -0.137759, -0.0983442, -0.0579879, -0.0170464, 0.024104, 0.0650764, 0.105483, 0.144944, 0.183098, 0.219612, 0.254186, 0.28656, 0.316524, 0.343915, 0.368621, 0.390584, 0.409795, 0.426292, 0.440156, 0.451507, 0.460498, 0.467307, 0.472133, 0.475188, 0.476689, 0.476858, 0.475909, 0.474048, 0.471469, 0.468346, 0.464835, 0.461068, 0.457151, 0.453167, 0.449169, 0.445183, 0.441208, 0.437214, 0.433147, 0.428923, 0.424436, 0.419558, 0.41414, 0.408015, 0.401003, 0.392914, 0.383553, 0.372724, 0.360238, 0.345915, 0.329592, 0.311133, 0.290427, 0.2674, 0.242019, 0.214294, 0.184283, 0.152093, 0.117882, 0.0818543, 0.0442621, 0.00539811, -0.0344093, -0.0748037, -0.115409, -0.155837, -0.195702, -0.234622, -0.272238, -0.308215, -0.342253, -0.374094, -0.403525, -0.430385, -0.454563, -0.475999, -0.494684, -0.510657, -0.523999, -0.53483, -0.543302, -0.549594, -0.553905, -0.556445, -0.557434, -0.557092, -0.555633, -0.553265, -0.55018, -0.546553, -0.54254, -0.538271, -0.533855, -0.529373, -0.524879, -0.520398, -0.51593, -0.511445, -0.506888, -0.502176, -0.497203, -0.49184, -0.485938, -0.479331, -0.471838, -0.46327, -0.453432, -0.442128, -0.429168, -0.414372, -0.397579, -0.37865, -0.357476, -0.333983, -0.308137, -0.279949, -0.249476, -0.216827, -0.182157, -0.145672, -0.107624, -0.0683064, -0.0280466, 0.0127986, 0.053853, 0.0947294, 0.13504, 0.174405, 0.212464, 0.248883, 0.283361, 0.315641, 0.34551, 0.372806, 0.397417, 0.419286, 0.438403, 0.454805, 0.468575, 0.479833, 0.48873, 0.495446, 0.500179, 0.50314, 0.504548, 0.504624, 0.503582, 0.501629, 0.498958, 0.495743, 0.49214, 0.48828, 0.484272, 0.480196, 0.476106, 0.472029, 0.467963, 0.463878, 0.45972, 0.455405, 0.450828, 0.44586, 0.440351, 0.434136, 0.427034, 0.418855, 0.409405, 0.398487, 0.385911, 0.371498, 0.355087, 0.336539, 0.315744, 0.292629, 0.26716, 0.239346, 0.209247, 0.176969, 0.14267, 0.106555, 0.0688753, 0.029924, -0.00997061, -0.050452, -0.0911439, -0.131659, -0.17161, -0.210617, -0.248319, -0.284382, -0.318506, -0.350433, -0.37995, -0.406895, -0.431159, -0.45268, -0.47145, -0.487508, -0.500934, -0.51185, -0.520406, -0.526783, -0.531177, -0.533801, -0.534874, -0.534616, -0.533241, -0.530956, -0.527954, -0.52441, -0.52048, -0.516294, -0.51196, -0.507561, -0.503148, -0.49875, -0.494364, -0.489961, -0.485485, -0.480855, -0.475963, -0.470681, -0.46486, -0.458334, -0.450922, -0.442435, -0.432677, -0.421454, -0.408573, -0.393857, -0.377144, -0.358295, -0.3372, -0.313787, -0.28802, -0.259911, -0.229518, -0.196947, -0.162355, -0.125949, -0.0879797, -0.04874, -0.00855822, 0.0322092, 0.0731858, 0.113985, 0.154218, 0.193506, 0.231488, 0.267829, 0.302231, 0.334434, 0.364226, 0.391446, 0.415982, 0.437774, 0.456815, 0.473142, 0.486836, 0.498018, 0.50684, 0.513481, 0.518139, 0.521025, 0.522359, 0.52236, 0.521244, 0.519217, 0.516471, 0.513182, 0.509505, 0.505572, 0.50149, 0.497341, 0.493178, 0.489028, 0.484889, 0.480732, 0.476501, 0.472114, 0.467464, 0.462424, 0.456843, 0.450556, 0.443382, 0.435132, 0.42561, 0.414621, 0.401974, 0.387491, 0.371009, 0.352389, 0.331524, 0.308339, 0.282799, 0.254916, 0.224747, 0.1924, 0.158031, 0.121846, 0.084097, 0.0450766, 0.00511299, -0.0354372, -0.0761978, -0.116782, -0.156801, -0.195876, -0.233646, -0.269777, -0.303969, -0.335963, -0.365548, -0.392561, -0.416891, -0.43848, -0.457317, -0.473441, -0.486934, -0.497916, -0.506539, -0.512982, -0.517442, -0.520132, -0.521271, -0.521078, -0.519769, -0.517549, -0.514613, -0.511134, -0.507268, -0.503147, -0.498878, -0.494542, -0.490195, -0.48586, -0.481538, -0.477199, -0.472787, -0.46822, -0.463391, -0.458173, -0.452415, -0.445952, -0.438603, -0.430179, -0.420483, -0.409322, -0.396504, -0.38185, -0.365199, -0.346411, -0.325378, -0.302026, -0.276321, -0.248273, -0.217941, -0.185431, -0.1509, -0.114554, -0.0766456, -0.0374662, 0.00265537, 0.0433627, 0.0842794, 0.125019, 0.165192, 0.204421, 0.242343, 0.278626, 0.312968, 0.345112, 0.374846, 0.402007, 0.426484, 0.448218, 0.467201, 0.48347, 0.497106, 0.508231, 0.516995, 0.523578, 0.528179, 0.531008, 0.532285, 0.532229, 0.531056, 0.528972, 0.52617, 0.522825, 0.519092, 0.515102, 0.510965, 0.50676, 0.502541, 0.498336, 0.494141, 0.489929, 0.485643, 0.481201, 0.476497, 0.471402, 0.465767, 0.459425, 0.452197, 0.443893, 0.434317, 0.423274, 0.410574, 0.396037, 0.379501, 0.360829, 0.339911, 0.316672, 0.29108, 0.263144, 0.232922, 0.200523, 0.166101, 0.129865, 0.0920637, 0.0529915, 0.0129762, -0.0276256, -0.0684375, -0.109073, -0.149143, -0.188269, -0.22609, -0.262272, -0.296514, -0.328559, -0.358194, -0.385257, -0.409637, -0.431276, -0.450163, -0.466337, -0.479879, -0.490911, -0.499583, -0.506074, -0.510584, -0.513323, -0.51451, -0.514365, -0.513104, -0.510933, -0.508045, -0.504614, -0.500796, -0.496722, -0.492501, -0.488213, -0.483912, -0.479625, -0.47535, -0.471058, -0.466693, -0.462172, -0.45739, -0.452218, -0.446506, -0.440089, -0.432786, -0.424408, -0.414758, -0.403642, -0.390869, -0.376261, -0.359655, -0.340912, -0.319924, -0.296617, -0.270957, -0.242953, -0.212665, -0.180199, -0.145712, -0.109411, -0.0715458, -0.0324101, 0.00766796, 0.0483319, 0.0892053, 0.129901, 0.170032, 0.209218, 0.247098, 0.283337, 0.317637, 0.349739, 0.37943, 0.406549, 0.430984, 0.452677, 0.471618, 0.487845, 0.50144, 0.512523, 0.521246, 0.527789, 0.532348, 0.535136, 0.536373, 0.536276, 0.535063, 0.532939, 0.530096, 0.526711, 0.522938, 0.518909, 0.514732, 0.510487, 0.50623, 0.501985, 0.497751, 0.4935, 0.489175, 0.484694, 0.479951, 0.474818, 0.469144, 0.462765, 0.455499, 0.447156, 0.437543, 0.426462, 0.413724, 0.399149, 0.382577, 0.363867, 0.342912, 0.319636, 0.294007, 0.266035, 0.235776, 0.20334, 0.168883, 0.13261, 0.0947726, 0.0556644, 0.0156132, -0.0250243, -0.0658718, -0.106542, -0.146648, -0.18581, -0.223666, -0.259882, -0.294159, -0.326239, -0.355909, -0.383006, -0.407421, -0.429093, -0.448014, -0.464223, -0.477799, -0.488864, -0.49757, -0.504095, -0.508638, -0.51141, -0.51263, -0.512519, -0.511291, -0.509153, -0.506297, -0.502898, -0.499113, -0.495072, -0.490883, -0.486627, -0.482358, -0.478103, -0.473859, -0.469599, -0.465265, -0.460776, -0.456025, -0.450884, -0.445203, -0.438817, -0.431545, -0.423197, -0.413578, -0.402492, -0.38975, -0.375172, -0.358595, -0.339883, -0.318925, -0.295648, -0.270017, -0.242043, -0.211784, -0.179347, -0.14489, -0.108617, -0.0707809, -0.0316741, 0.00837532, 0.0490107, 0.0898557, 0.130523, 0.170626, 0.209783, 0.247635, 0.283847, 0.318119, 0.350193, 0.379857, 0.406948, 0.431356, 0.453022, 0.471935, 0.488136, 0.501704, 0.51276, 0.521457, 0.527973, 0.532506, 0.535268, 0.536478, 0.536355, 0.535116, 0.532966, 0.530098, 0.526687, 0.522888, 0.518834, 0.514632, 0.510362, 0.506079, 0.501809, 0.49755, 0.493274, 0.488925, 0.484419, 0.479652, 0.474494, 0.468797, 0.462393, 0.455103, 0.446737, 0.437099, 0.425995, 0.413233, 0.398635, 0.382039, 0.363306, 0.342328, 0.319029, 0.293377, 0.265382, 0.235101, 0.202642, 0.168162, 0.131867, 0.0940072, 0.0548768, 0.0148036, -0.0258559, -0.0667254, -0.107418, -0.147545, -0.186728, -0.224606, -0.260844, -0.295142, -0.327243, -0.356934, -0.384052, -0.408488, -0.430181, -0.449123, -0.465351, -0.478948, -0.490034, -0.49876, -0.505305, -0.509868, -0.51266, -0.5139, -0.513808, -0.5126, -0.510481, -0.507645, -0.504266, -0.500499, -0.496477, -0.492307, -0.48807, -0.483821, -0.479584, -0.475359, -0.471117, -0.466802, -0.462331, -0.457599, -0.452476, -0.446813, -0.440445, -0.433191, -0.42486, -0.415259, -0.404191, -0.391466, -0.376905, -0.360346, -0.341651, -0.32071, -0.297449, -0.271836, -0.243878, -0.213636, -0.181216, -0.146775, -0.110519, -0.0726992, -0.0336086, 0.00642463, 0.0470439, 0.087873, 0.128525, 0.168611, 0.207753, 0.24559, 0.281786, 0.316043, 0.348101, 0.37775, 0.404826, 0.429219, 0.45087, 0.469768, 0.485954, 0.499507, 0.510549, 0.519231, 0.525733, 0.530252, 0.532999, 0.534195, 0.534059, 0.532805, 0.530641, 0.52776, 0.524335, 0.520523, 0.516455, 0.512239, 0.507956, 0.50366, 0.499377, 0.495105, 0.490816, 0.486454, 0.481936, 0.477156, 0.471985, 0.466275, 0.459859, 0.452556, 0.444178, 0.434528, 0.423412, 0.410638, 0.396028, 0.37942, 0.360675, 0.339685, 0.316375, 0.290712, 0.262705, 0.232412, 0.199942, 0.165451, 0.129144, 0.0912741, 0.0521327, 0.0120487, -0.0286216, -0.0695018, -0.110205, -0.150343, -0.189536, -0.227424, -0.263672, -0.297981, -0.330092, -0.359793, -0.386921, -0.411367, -0.43307, -0.452021, -0.468259, -0.481866, -0.492961, -0.501696, -0.508251, -0.512823, -0.515624, -0.516874, -0.516791, -0.515591, -0.513481, -0.510654, -0.507283, -0.503526, -0.499512, -0.495351, -0.491122, -0.486881, -0.482652, -0.478436, -0.474202, -0.469894, -0.465432, -0.460707, -0.455592, -0.449937, -0.443577, -0.43633, -0.428007, -0.418413, -0.407353, -0.394635, -0.380081, -0.363529, -0.344841, -0.323907, -0.300654, -0.275047, -0.247096, -0.216861, -0.184447, -0.150013, -0.113763, -0.0759498, -0.0368655, 0.00316143, 0.0437745, 0.0845974, 0.125243, 0.165324, 0.20446, 0.24229, 0.278481, 0.312732, 0.344785, 0.374428, 0.401499, 0.425886, 0.447531, 0.466425, 0.482605, 0.496153, 0.50719, 0.515867, 0.522364, 0.526877, 0.52962, 0.530811, 0.53067, 0.529412, 0.527244, 0.524357, 0.520929, 0.517112, 0.51304, 0.50882, 0.504532, 0.500232, 0.495945, 0.49167, 0.487377, 0.48301, 0.478488, 0.473705, 0.468531, 0.462817, 0.456397, 0.449091, 0.440709, 0.431056, 0.419936, 0.407159, 0.392546, 0.375935, 0.357188, 0.336194, 0.312882, 0.287215, 0.259205, 0.22891, 0.196437, 0.161944, 0.125635, 0.0877617, 0.0486179, 0.00853148, -0.0321411, -0.0730235, -0.113729, -0.153869, -0.193064};
        
        WHEN("The sine wave is processed") {
            mProcessor.prepareToPlay(sampleRate, mSampleBuffer.getNumSamples());
            MidiBuffer mMidiBuffer;
            mProcessor.processBlock(mSampleBuffer, mMidiBuffer);
            THEN("The output is as expected") {
                const float* readPointer1 {mSampleBuffer.getReadPointer(0)};
                const float* readPointer2 {mSampleBuffer.getReadPointer(1)};
                
                for (int iii {}; iii < mSampleBuffer.getNumSamples(); iii++) {
                    REQUIRE(CoreTestLib::compareFloats(readPointer1[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                    REQUIRE(CoreTestLib::compareFloats(readPointer2[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                }
            }
        }
    }
    
    GIVEN("A new CarveAudioProcessor object, sample rate of 96kHz, and a 400Hz sine wave") {
        AudioSampleBuffer mSampleBuffer(2, 1024);
        CarveAudioProcessor mProcessor;
        mProcessor.setParameter(CarveAudioProcessor::mode1, 2);
        mProcessor.setParameter(CarveAudioProcessor::routing, 1);
        
        const int sampleRate {96000};
        
        ToneGeneratorAudioSource sineGenerator;
        sineGenerator.setAmplitude(0.5);
        sineGenerator.setFrequency(400);
        sineGenerator.prepareToPlay(mSampleBuffer.getNumSamples(), sampleRate);
        sineGenerator.getNextAudioBlock(AudioSourceChannelInfo(mSampleBuffer));
        
        float expectedOutput[] {-9.00369e-10, 0.000924295, 0.00629274, 0.0201512, 0.0416256, 0.0650111, 0.0859732, 0.104627, 0.122985, 0.141922, 0.160878, 0.17914, 0.196598, 0.213499, 0.229978, 0.245956, 0.261304, 0.275978, 0.289995, 0.303368, 0.316082, 0.328114, 0.339451, 0.350096, 0.360055, 0.369331, 0.377928, 0.385854, 0.393122, 0.399746, 0.405744, 0.411131, 0.41593, 0.420161, 0.423848, 0.427015, 0.429688, 0.431892, 0.433655, 0.435005, 0.435967, 0.436571, 0.436844, 0.436812, 0.436502, 0.435941, 0.435154, 0.434166, 0.432999, 0.431677, 0.430221, 0.428651, 0.426985, 0.42524, 0.423433, 0.421577, 0.419685, 0.417768, 0.415835, 0.413893, 0.411948, 0.410005, 0.408065, 0.40613, 0.404197, 0.402265, 0.400328, 0.39838, 0.396413, 0.394418, 0.392384, 0.390297, 0.388144, 0.385909, 0.383576, 0.381125, 0.378539, 0.375796, 0.372875, 0.369754, 0.366409, 0.362818, 0.358957, 0.3548, 0.350323, 0.345502, 0.340313, 0.334731, 0.328733, 0.322296, 0.315398, 0.308018, 0.300137, 0.291736, 0.282799, 0.273312, 0.263262, 0.252639, 0.241435, 0.229644, 0.217263, 0.204293, 0.190737, 0.1766, 0.161891, 0.146623, 0.13081, 0.114471, 0.0976272, 0.0803032, 0.0625263, 0.0443268, 0.0257377, 0.00679451, -0.0124646, -0.0319995, -0.051768, -0.071726, -0.0918281, -0.112028, -0.132277, -0.152528, -0.172731, -0.192839, -0.212802, -0.232573, -0.252105, -0.271352, -0.290269, -0.308815, -0.326947, -0.344628, -0.361822, -0.378494, -0.394614, -0.410155, -0.425092, -0.439401, -0.453067, -0.466072, -0.478405, -0.490057, -0.501023, -0.5113, -0.520889, -0.529793, -0.538019, -0.545575, -0.552474, -0.55873, -0.564359, -0.569379, -0.57381, -0.577674, -0.580995, -0.583796, -0.586103, -0.587943, -0.589342, -0.590327, -0.590926, -0.591167, -0.591077, -0.590683, -0.590012, -0.58909, -0.587943, -0.586594, -0.585069, -0.583387, -0.581573, -0.579644, -0.577621, -0.575519, -0.573355, -0.571143, -0.568895, -0.566623, -0.564335, -0.562039, -0.55974, -0.557444, -0.555151, -0.552863, -0.550579, -0.548295, -0.546007, -0.543709, -0.541392, -0.539047, -0.536664, -0.534229, -0.531728, -0.529145, -0.526465, -0.523668, -0.520735, -0.517646, -0.51438, -0.510914, -0.507225, -0.50329, -0.499085, -0.494585, -0.489766, -0.484604, -0.479073, -0.47315, -0.466811, -0.460034, -0.452796, -0.445077, -0.436857, -0.428119, -0.418844, -0.40902, -0.398633, -0.387674, -0.376134, -0.364007, -0.351292, -0.337987, -0.324097, -0.309626, -0.294584, -0.278983, -0.262838, -0.246168, -0.228993, -0.211338, -0.193231, -0.174702, -0.155783, -0.136511, -0.116923, -0.0970606, -0.0769646, -0.0566795, -0.0362508, -0.0157251, 0.00484983, 0.0254258, 0.045954, 0.0663859, 0.0866731, 0.106768, 0.126622, 0.146192, 0.165431, 0.184298, 0.202752, 0.220753, 0.238267, 0.255259, 0.271699, 0.287559, 0.302813, 0.317441, 0.331424, 0.344746, 0.357396, 0.369364, 0.380646, 0.391238, 0.401141, 0.41036, 0.418899, 0.426769, 0.433982, 0.44055, 0.446491, 0.451822, 0.456565, 0.46074, 0.464371, 0.467482, 0.470098, 0.472247, 0.473954, 0.475247, 0.476154, 0.476702, 0.476919, 0.476831, 0.476466, 0.47585, 0.475007, 0.473963, 0.472741, 0.471364, 0.469852, 0.468226, 0.466505, 0.464705, 0.462843, 0.460932, 0.458984, 0.457012, 0.455024, 0.453027, 0.451027, 0.449029, 0.447034, 0.445044, 0.443056, 0.441069, 0.439077, 0.437074, 0.435053, 0.433003, 0.430914, 0.428773, 0.426565, 0.424276, 0.421888, 0.419383, 0.416742, 0.413945, 0.410969, 0.407794, 0.404395, 0.40075, 0.396834, 0.392623, 0.388092, 0.383217, 0.377974, 0.372338, 0.366286, 0.359795, 0.352843, 0.345409, 0.337474, 0.32902, 0.320029, 0.310489, 0.300385, 0.289708, 0.27845, 0.266606, 0.254172, 0.241148, 0.227538, 0.213348, 0.198586, 0.183264, 0.167398, 0.151006, 0.134109, 0.116732, 0.0989019, 0.0806493, 0.0620071, 0.0430109, 0.0236988, 0.00411102, -0.0157103, -0.0357212, -0.0558761, -0.0761284, -0.0964304, -0.116734, -0.13699, -0.15715, -0.177166, -0.19699, -0.216574, -0.235873, -0.254843, -0.273441, -0.291626, -0.309359, -0.326605, -0.343329, -0.359502, -0.375095, -0.390083, -0.404445, -0.418163, -0.43122, -0.443605, -0.455309, -0.466327, -0.476655, -0.486296, -0.495252, -0.503529, -0.511138, -0.518088, -0.524396, -0.530076, -0.535147, -0.53963, -0.543546, -0.546918, -0.54977, -0.552129, -0.55402, -0.55547, -0.556507, -0.557157, -0.557449, -0.55741, -0.557067, -0.556447, -0.555576, -0.55448, -0.553182, -0.551707, -0.550077, -0.548313, -0.546435, -0.544462, -0.542411, -0.540298, -0.538137, -0.535939, -0.533718, -0.53148, -0.529234, -0.526986, -0.52474, -0.522498, -0.52026, -0.518026, -0.515792, -0.513555, -0.511306, -0.50904, -0.506745, -0.504412, -0.502027, -0.499575, -0.497043, -0.494412, -0.491665, -0.488782, -0.485743, -0.482526, -0.47911, -0.475471, -0.471586, -0.46743, -0.46298, -0.458211, -0.453097, -0.447616, -0.441742, -0.435453, -0.428725, -0.421537, -0.413867, -0.405696, -0.397006, -0.387781, -0.378006, -0.367668, -0.356758, -0.345266, -0.333189, -0.320522, -0.307266, -0.293425, -0.279003, -0.26401, -0.248457, -0.232361, -0.215739, -0.198613, -0.181006, -0.162948, -0.144467, -0.125597, -0.106373, -0.0868337, -0.0670191, -0.0469714, -0.0267345, -0.0063539, 0.0141236, 0.0346505, 0.0551784, 0.0756586, 0.0960426, 0.116282, 0.136328, 0.156135, 0.175657, 0.194849, 0.213668, 0.232074, 0.250028, 0.267494, 0.284438, 0.300831, 0.316643, 0.33185, 0.34643, 0.360366, 0.373641, 0.386243, 0.398164, 0.409398, 0.419943, 0.4298, 0.438971, 0.447464, 0.455287, 0.462452, 0.468973, 0.474867, 0.480152, 0.484847, 0.488975, 0.492559, 0.495624, 0.498194, 0.500296, 0.501956, 0.503203, 0.504063, 0.504565, 0.504735, 0.504601, 0.50419, 0.503527, 0.502638, 0.501548, 0.500279, 0.498856, 0.497298, 0.495626, 0.493859, 0.492013, 0.490104, 0.488147, 0.486154, 0.484136, 0.482102, 0.480059, 0.478014, 0.47597, 0.473929, 0.471893, 0.46986, 0.467827, 0.46579, 0.463741, 0.461675, 0.459579, 0.457445, 0.455258, 0.453005, 0.450671, 0.448238, 0.445688, 0.443002, 0.440159, 0.437138, 0.433918, 0.430474, 0.426784, 0.422823, 0.418567, 0.413992, 0.409072, 0.403784, 0.398103, 0.392007, 0.385471, 0.378474, 0.370996, 0.363016, 0.354517, 0.345483, 0.335898, 0.32575, 0.315028, 0.303726, 0.291837, 0.279359, 0.266291, 0.252637, 0.238403, 0.223597, 0.208231, 0.192321, 0.175885, 0.158944, 0.141523, 0.123649, 0.105353, 0.0866668, 0.0676269, 0.0482711, 0.0286396, 0.0087747, -0.0112797, -0.0314782, -0.051774, -0.0721194, -0.0924662, -0.112766, -0.132969, -0.153028, -0.172895, -0.192523, -0.211865, -0.230878, -0.249519, -0.267747, -0.285524, -0.302812, -0.31958, -0.335795, -0.351431, -0.366462, -0.380867, -0.394627, -0.407727, -0.420155, -0.431902, -0.442962, -0.453333, -0.463017, -0.472015, -0.480335, -0.487985, -0.494979, -0.501328, -0.507051, -0.512165, -0.51669, -0.520648, -0.524062, -0.526956, -0.529357, -0.53129, -0.532782, -0.533861, -0.534553, -0.534887, -0.53489, -0.534589, -0.534011, -0.533181, -0.532127, -0.530871, -0.529437, -0.527849, -0.526126, -0.52429, -0.522358, -0.520349, -0.518277, -0.516157, -0.514001, -0.51182, -0.509624, -0.50742, -0.505213, -0.503008, -0.500807, -0.49861, -0.496417, -0.494224, -0.492027, -0.48982, -0.487594, -0.48534, -0.483048, -0.480703, -0.478293, -0.475801, -0.473211, -0.470504, -0.467662, -0.464663, -0.461487, -0.458111, -0.454513, -0.450668, -0.446553, -0.442143, -0.437413, -0.43234, -0.426899, -0.421066, -0.414816, -0.408128, -0.40098, -0.39335, -0.385219, -0.37657, -0.367384, -0.357649, -0.347351, -0.33648, -0.325029, -0.312991, -0.300364, -0.287148, -0.273345, -0.258963, -0.244009, -0.228497, -0.21244, -0.195857, -0.17877, -0.161203, -0.143184, -0.124742, -0.105911, -0.0867265, -0.0672263, -0.0474508, -0.0274421, -0.00724415, 0.0130975, 0.0335361, 0.0540241, 0.0745131, 0.0949546, 0.1153, 0.1355, 0.155508, 0.175276, 0.194759, 0.213913, 0.232693, 0.251061, 0.268976, 0.286404, 0.30331, 0.319664, 0.335438, 0.350607, 0.365149, 0.379046, 0.392283, 0.404847, 0.41673, 0.427926, 0.438433, 0.448252, 0.457385, 0.46584, 0.473625, 0.480752, 0.487236, 0.493092, 0.498339, 0.502997, 0.507087, 0.510634, 0.51366, 0.516193, 0.518257, 0.519881, 0.52109, 0.521913, 0.522377, 0.52251, 0.522339, 0.52189, 0.52119, 0.520264, 0.519136, 0.517831, 0.516371, 0.514776, 0.513067, 0.511263, 0.50938, 0.507435, 0.505441, 0.503411, 0.501356, 0.499285, 0.497206, 0.495124, 0.493043, 0.490966, 0.488893, 0.486824, 0.484755, 0.482681, 0.480596, 0.478493, 0.476362, 0.474191, 0.471968, 0.469679, 0.467308, 0.464839, 0.462253, 0.459531, 0.456652, 0.453596, 0.450339, 0.44686, 0.443134, 0.439137, 0.434846, 0.430234, 0.425279, 0.419955, 0.414239, 0.408107, 0.401535, 0.394503, 0.386989, 0.378974, 0.37044, 0.36137, 0.35175, 0.341566, 0.33081, 0.319473, 0.307549, 0.295035, 0.281932, 0.268243, 0.253974, 0.239133, 0.223732, 0.207787, 0.191316, 0.17434, 0.156885, 0.138976, 0.120645, 0.101924, 0.0828499, 0.0634595, 0.0437935, 0.023894, 0.00380508, -0.0164278, -0.036758, -0.0571378, -0.0775189, -0.0978528, -0.118091, -0.138184, -0.158085, -0.177747, -0.197123, -0.216171, -0.234845, -0.253107, -0.270918, -0.28824, -0.305042, -0.321291, -0.336961, -0.352026, -0.366464, -0.380258, -0.393392, -0.405853, -0.417633, -0.428727, -0.439132, -0.448849, -0.45788, -0.466234, -0.473918, -0.480944, -0.487328, -0.493083, -0.49823, -0.502788, -0.50678, -0.510227, -0.513155, -0.515588, -0.517554, -0.519079, -0.520191, -0.520916, -0.521283, -0.521318, -0.52105, -0.520505, -0.519708, -0.518686, -0.517463, -0.516062, -0.514506, -0.512816, -0.511012, -0.509113, -0.507136, -0.505097, -0.503009, -0.500885, -0.498737, -0.496573, -0.494401, -0.492226, -0.490053, -0.487884, -0.485719, -0.483558, -0.481397, -0.479232, -0.477057, -0.474863, -0.472641, -0.47038, -0.468068, -0.465689, -0.463229, -0.46067, -0.457995, -0.455184, -0.452217, -0.449073, -0.445728, -0.442161, -0.438348, -0.434264, -0.429885, -0.425187, -0.420146, -0.414736, -0.408933, -0.402715, -0.396058, -0.388941, -0.381342, -0.373242, -0.364623, -0.355469, -0.345764, -0.335497, -0.324657, -0.313237, -0.301229, -0.288633, -0.275448, -0.261676, -0.247324, -0.232401, -0.216919, -0.200893, -0.18434, -0.167284, -0.149747, -0.131758, -0.113347, -0.0945461, -0.0753917, -0.0559218, -0.0361764, -0.0161978, 0.00397007, 0.0242816, 0.0446902, 0.0651482, 0.0856073, 0.106019, 0.126334, 0.146505, 0.166483, 0.186222, 0.205675, 0.224798, 0.243549, 0.261887, 0.279773, 0.297171, 0.314048, 0.330372, 0.346117, 0.361256, 0.375769, 0.389637, 0.402844, 0.415379, 0.427233, 0.4384, 0.448878, 0.458667, 0.467771, 0.476197, 0.483953, 0.491052, 0.497506, 0.503333, 0.508551, 0.513181, 0.517242, 0.52076, 0.523758, 0.526262, 0.528298, 0.529892, 0.531073, 0.531868, 0.532303, 0.532408, 0.532208, 0.531731, 0.531002, 0.530048, 0.528892, 0.527559, 0.52607, 0.524447, 0.52271, 0.520878, 0.518967, 0.516993, 0.514972, 0.512914, 0.510831, 0.508732, 0.506625, 0.504515, 0.502406, 0.500302, 0.498201};
        
        WHEN("The sine wave is processed") {
            mProcessor.prepareToPlay(sampleRate, mSampleBuffer.getNumSamples());
            MidiBuffer mMidiBuffer;
            mProcessor.processBlock(mSampleBuffer, mMidiBuffer);
            THEN("The output is as expected") {
                const float* readPointer1 {mSampleBuffer.getReadPointer(0)};
                const float* readPointer2 {mSampleBuffer.getReadPointer(1)};
                
                for (int iii {}; iii < mSampleBuffer.getNumSamples(); iii++) {
                    REQUIRE(CoreTestLib::compareFloats(readPointer1[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                    REQUIRE(CoreTestLib::compareFloats(readPointer2[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                }
            }
        }
    }
    
    GIVEN("A new CarveAudioProcessor object, sample rate of 192kHz, and a 400Hz sine wave") {
        AudioSampleBuffer mSampleBuffer(2, 1024);
        CarveAudioProcessor mProcessor;
        mProcessor.setParameter(CarveAudioProcessor::mode1, 2);
        mProcessor.setParameter(CarveAudioProcessor::routing, 1);
        
        const int sampleRate {192000};
        
        ToneGeneratorAudioSource sineGenerator;
        sineGenerator.setAmplitude(0.5);
        sineGenerator.setFrequency(400);
        sineGenerator.prepareToPlay(mSampleBuffer.getNumSamples(), sampleRate);
        sineGenerator.getNextAudioBlock(AudioSourceChannelInfo(mSampleBuffer));
        
        float expectedOutput[] {-9.30561e-11, 4.78039e-05, 0.00040077, 0.00165619, 0.00459162, 0.00978661, 0.0173462, 0.0268827, 0.0376967, 0.0490283, 0.0602657, 0.0710523, 0.0812884, 0.0910606, 0.100543, 0.109911, 0.119281, 0.128701, 0.138155, 0.14759, 0.156947, 0.166177, 0.175252, 0.184166, 0.192924, 0.20154, 0.210023, 0.21838, 0.226609, 0.234704, 0.242659, 0.250465, 0.258116, 0.265608, 0.272938, 0.280105, 0.287109, 0.293949, 0.300623, 0.307131, 0.313471, 0.319641, 0.325641, 0.331468, 0.337124, 0.342606, 0.347916, 0.353054, 0.35802, 0.362814, 0.367438, 0.371891, 0.376175, 0.380291, 0.384241, 0.388025, 0.391646, 0.395105, 0.398404, 0.401546, 0.404531, 0.407364, 0.410045, 0.412578, 0.414965, 0.417209, 0.419313, 0.42128, 0.423112, 0.424813, 0.426386, 0.427834, 0.42916, 0.430368, 0.431461, 0.432442, 0.433314, 0.434082, 0.434748, 0.435316, 0.435789, 0.436172, 0.436466, 0.436676, 0.436806, 0.436858, 0.436835, 0.436743, 0.436582, 0.436357, 0.436072, 0.435728, 0.43533, 0.43488, 0.434382, 0.433838, 0.433251, 0.432624, 0.43196, 0.431261, 0.430531, 0.42977, 0.428983, 0.42817, 0.427335, 0.42648, 0.425606, 0.424716, 0.423811, 0.422893, 0.421964, 0.421026, 0.420079, 0.419125, 0.418166, 0.417203, 0.416236, 0.415266, 0.414295, 0.413323, 0.412351, 0.411379, 0.410407, 0.409437, 0.408467, 0.407498, 0.406531, 0.405564, 0.404598, 0.403632, 0.402666, 0.401699, 0.40073, 0.399759, 0.398785, 0.397807, 0.396823, 0.395833, 0.394835, 0.393828, 0.39281, 0.39178, 0.390736, 0.389676, 0.388598, 0.387501, 0.386382, 0.385239, 0.384071, 0.382874, 0.381646, 0.380386, 0.37909, 0.377756, 0.376382, 0.374964, 0.3735, 0.371987, 0.370422, 0.368803, 0.367127, 0.36539, 0.36359, 0.361723, 0.359787, 0.357778, 0.355694, 0.353531, 0.351286, 0.348957, 0.34654, 0.344032, 0.34143, 0.338731, 0.335932, 0.33303, 0.330023, 0.326907, 0.32368, 0.320338, 0.31688, 0.313302, 0.309602, 0.305778, 0.301828, 0.297748, 0.293537, 0.289193, 0.284714, 0.280098, 0.275344, 0.270449, 0.265413, 0.260233, 0.25491, 0.249442, 0.243828, 0.238068, 0.23216, 0.226105, 0.219903, 0.213553, 0.207056, 0.200412, 0.193622, 0.186686, 0.179606, 0.172382, 0.165016, 0.157509, 0.149864, 0.142081, 0.134163, 0.126113, 0.117933, 0.109625, 0.101193, 0.0926392, 0.0839673, 0.0751806, 0.0662828, 0.0572776, 0.0481691, 0.0389613, 0.0296586, 0.0202655, 0.0107865, 0.00122642, -0.00840981, -0.0181172, -0.0278904, -0.0377244, -0.0476136, -0.0575526, -0.0675357, -0.0775573, -0.0876115, -0.0976926, -0.107795, -0.117912, -0.128037, -0.138166, -0.148292, -0.158408, -0.168509, -0.178589, -0.188641, -0.198659, -0.208638, -0.218572, -0.228454, -0.238278, -0.248039, -0.257732, -0.26735, -0.276887, -0.28634, -0.295701, -0.304966, -0.31413, -0.323188, -0.332136, -0.340967, -0.349678, -0.358265, -0.366724, -0.37505, -0.383239, -0.391288, -0.399193, -0.406952, -0.414561, -0.422017, -0.429317, -0.43646, -0.443442, -0.450261, -0.456916, -0.463406, -0.469727, -0.47588, -0.481863, -0.487676, -0.493316, -0.498785, -0.504082, -0.509207, -0.514159, -0.518939, -0.523548, -0.527986, -0.532254, -0.536353, -0.540284, -0.544049, -0.547649, -0.551085, -0.554359, -0.557474, -0.560431, -0.563233, -0.565881, -0.568379, -0.570728, -0.572931, -0.574992, -0.576912, -0.578696, -0.580345, -0.581863, -0.583253, -0.584518, -0.585662, -0.586687, -0.587597, -0.588395, -0.589086, -0.589671, -0.590156, -0.590542, -0.590833, -0.591034, -0.591147, -0.591176, -0.591124, -0.590995, -0.590792, -0.590518, -0.590177, -0.589772, -0.589305, -0.588782, -0.588203, -0.587573, -0.586895, -0.586171, -0.585404, -0.584598, -0.583754, -0.582876, -0.581966, -0.581026, -0.58006, -0.579068, -0.578054, -0.57702, -0.575968, -0.574899, -0.573816, -0.57272, -0.571613, -0.570496, -0.569372, -0.568241, -0.567104, -0.565963, -0.564819, -0.563672, -0.562524, -0.561375, -0.560225, -0.559077, -0.557928, -0.556781, -0.555635, -0.55449, -0.553346, -0.552203, -0.551061, -0.54992, -0.548778, -0.547635, -0.546491, -0.545345, -0.544196, -0.543042, -0.541884, -0.540719, -0.539546, -0.538364, -0.537172, -0.535967, -0.534749, -0.533514, -0.532263, -0.530991, -0.529699, -0.528382, -0.52704, -0.52567, -0.524269, -0.522836, -0.521367, -0.51986, -0.518312, -0.516722, -0.515085, -0.5134, -0.511663, -0.509872, -0.508023, -0.506114, -0.504142, -0.502103, -0.499995, -0.497815, -0.495559, -0.493225, -0.490809, -0.488309, -0.485721, -0.483042, -0.480269, -0.4774, -0.47443, -0.471358, -0.468181, -0.464894, -0.461497, -0.457986, -0.454358, -0.45061, -0.446741, -0.442748, -0.438628, -0.434379, -0.429999, -0.425486, -0.420838, -0.416053, -0.41113, -0.406067, -0.400862, -0.395514, -0.390023, -0.384387, -0.378605, -0.372677, -0.366601, -0.360379, -0.354009, -0.347492, -0.340828, -0.334017, -0.32706, -0.319957, -0.31271, -0.305319, -0.297787, -0.290114, -0.282302, -0.274353, -0.266269, -0.258053, -0.249707, -0.241233, -0.232636, -0.223916, -0.215079, -0.206127, -0.197064, -0.187894, -0.178621, -0.169248, -0.159781, -0.150223, -0.140579, -0.130855, -0.121055, -0.111183, -0.101246, -0.0912479, -0.081195, -0.0710923, -0.0609457, -0.0507607, -0.0405432, -0.0302989, -0.0200338, -0.00975394, 0.000534799, 0.0108263, 0.0211146, 0.0313934, 0.0416569, 0.0518987, 0.062113, 0.0722936, 0.0824344, 0.0925296, 0.102573, 0.112559, 0.122482, 0.132336, 0.142115, 0.151814, 0.161427, 0.170949, 0.180375, 0.1897, 0.198919, 0.208026, 0.217018, 0.22589, 0.234637, 0.243255, 0.251741, 0.26009, 0.268299, 0.276364, 0.284282, 0.29205, 0.299665, 0.307124, 0.314426, 0.321567, 0.328545, 0.335359, 0.342006, 0.348487, 0.354798, 0.360939, 0.366909, 0.372708, 0.378335, 0.38379, 0.389072, 0.394181, 0.399119, 0.403885, 0.40848, 0.412906, 0.417162, 0.42125, 0.425171, 0.428927, 0.43252, 0.435951, 0.439222, 0.442335, 0.445292, 0.448097, 0.45075, 0.453255, 0.455614, 0.45783, 0.459906, 0.461845, 0.463649, 0.465322, 0.466867, 0.468287, 0.469585, 0.470765, 0.471829, 0.472782, 0.473627, 0.474367, 0.475005, 0.475545, 0.47599, 0.476345, 0.476611, 0.476794, 0.476895, 0.476919, 0.476869, 0.476748, 0.47656, 0.476308, 0.475994, 0.475623, 0.475197, 0.47472, 0.474193, 0.473622, 0.473007, 0.472352, 0.47166, 0.470934, 0.470175, 0.469387, 0.468572, 0.467732, 0.466869, 0.465986, 0.465085, 0.464167, 0.463234, 0.462289, 0.461332, 0.460366, 0.459392, 0.458411, 0.457424, 0.456433, 0.455438, 0.454441, 0.453443, 0.452443, 0.451443, 0.450444, 0.449445, 0.448447, 0.447449, 0.446453, 0.445458, 0.444464, 0.44347, 0.442477, 0.441483, 0.440489, 0.439493, 0.438495, 0.437493, 0.436488, 0.435477, 0.434459, 0.433434, 0.432399, 0.431354, 0.430297, 0.429225, 0.428138, 0.427033, 0.425908, 0.424762, 0.423592, 0.422396, 0.421172, 0.419917, 0.41863, 0.417307, 0.415946, 0.414544, 0.413099, 0.411608, 0.410068, 0.408476, 0.40683, 0.405126, 0.403362, 0.401535, 0.399641, 0.397677, 0.395642, 0.39353, 0.39134, 0.389069, 0.386712, 0.384268, 0.381733, 0.379104, 0.376378, 0.373552, 0.370624, 0.367589, 0.364446, 0.361192, 0.357824, 0.354338, 0.350734, 0.347007, 0.343156, 0.339179, 0.335072, 0.330834, 0.326464, 0.321958, 0.317315, 0.312533, 0.307612, 0.302549, 0.297343, 0.291993, 0.286498, 0.280857, 0.27507, 0.269135, 0.263054, 0.256825, 0.250448, 0.243925, 0.237254, 0.230437, 0.223475, 0.216367, 0.209117, 0.201724, 0.194191, 0.186518, 0.178709, 0.170765, 0.162688, 0.154481, 0.146147, 0.137688, 0.129108, 0.120409, 0.111596, 0.102672, 0.0936398, 0.0845047, 0.0752704, 0.0659412, 0.0565216, 0.0470161, 0.0374295, 0.0277668, 0.018033, 0.00823326, -0.00162715, -0.0115428, -0.0215082, -0.0315178, -0.0415657, -0.0516464, -0.0617538, -0.0718822, -0.0820255, -0.0921778, -0.102333, -0.112485, -0.122628, -0.132755, -0.142861, -0.152939, -0.162984, -0.172989, -0.182949, -0.192857, -0.202708, -0.212495, -0.222214, -0.231858, -0.241422, -0.250901, -0.260288, -0.26958, -0.27877, -0.287854, -0.296827, -0.305685, -0.314422, -0.323036, -0.33152, -0.339872, -0.348087, -0.356163, -0.364094, -0.371879, -0.379514, -0.386996, -0.394322, -0.401491, -0.408499, -0.415344, -0.422025, -0.428541, -0.434888, -0.441067, -0.447076, -0.452914, -0.458581, -0.464076, -0.469399, -0.474549, -0.479527, -0.484334, -0.488968, -0.493432, -0.497726, -0.501851, -0.505808, -0.509599, -0.513224, -0.516686, -0.519986, -0.523127, -0.52611, -0.528937, -0.531611, -0.534135, -0.536509, -0.538739, -0.540825, -0.542771, -0.54458, -0.546255, -0.547799, -0.549215, -0.550505, -0.551675, -0.552725, -0.553661, -0.554485, -0.555201, -0.555813, -0.556322, -0.556734, -0.557052, -0.557278, -0.557416, -0.557471, -0.557445, -0.557341, -0.557163, -0.556915, -0.556599, -0.556219, -0.555779, -0.55528, -0.554728, -0.554123, -0.55347, -0.552772, -0.55203, -0.551249, -0.550431, -0.549578, -0.548694, -0.547779, -0.546838, -0.545872, -0.544884, -0.543875, -0.542848, -0.541804, -0.540747, -0.539676, -0.538594, -0.537503, -0.536404, -0.535298, -0.534186, -0.53307, -0.531951, -0.53083, -0.529707, -0.528583, -0.527459, -0.526335, -0.525212, -0.52409, -0.522969, -0.52185, -0.520731, -0.519613, -0.518496, -0.51738, -0.516263, -0.515145, -0.514026, -0.512905, -0.511781, -0.510653, -0.509519, -0.508379, -0.507232, -0.506075, -0.504907, -0.503728, -0.502534, -0.501325, -0.500098, -0.498852, -0.497584, -0.496293, -0.494976, -0.49363, -0.492254, -0.490846, -0.489402, -0.48792, -0.486397, -0.484831, -0.48322, -0.481559, -0.479847, -0.478081, -0.476257, -0.474373, -0.472425, -0.470411, -0.468328, -0.466173, -0.463942, -0.461632, -0.459241, -0.456766, -0.454202, -0.451548, -0.4488, -0.445955, -0.44301, -0.439963, -0.43681, -0.433549, -0.430176, -0.426689, -0.423086, -0.419363, -0.415518, -0.411549, -0.407454, -0.40323, -0.398874, -0.394386, -0.389762, -0.385002, -0.380104, -0.375065, -0.369885, -0.364562, -0.359095, -0.353483, -0.347725, -0.341822, -0.335771, -0.329573, -0.323228, -0.316735, -0.310095, -0.303309, -0.296376, -0.289297, -0.282075, -0.274708, -0.2672, -0.259551, -0.251764, -0.243839, -0.23578, -0.227588, -0.219266, -0.210817, -0.202244, -0.193549, -0.184736, -0.175808, -0.166769, -0.157623, -0.148374, -0.139025, -0.129582, -0.120049, -0.110429, -0.100729, -0.090953, -0.0811056, -0.0711925, -0.0612188, -0.0511899, -0.0411114, -0.0309889, -0.020828, -0.0106345, -0.00041431, 0.00982669, 0.0200825, 0.0303472, 0.0406147, 0.0508789, 0.0611338, 0.0713732, 0.0815911, 0.0917814, 0.101938, 0.112055, 0.122126, 0.132146, 0.142108, 0.152007, 0.161837, 0.171592, 0.181267, 0.190856, 0.200355, 0.209757, 0.219058, 0.228252, 0.237336, 0.246304, 0.255152, 0.263875, 0.27247, 0.280932, 0.289257, 0.297442, 0.305483, 0.313377, 0.321122, 0.328713, 0.336149, 0.343427, 0.350544, 0.357498, 0.364288, 0.370913, 0.377369, 0.383657, 0.389774, 0.395721, 0.401496, 0.407099, 0.41253, 0.417789, 0.422875, 0.427789, 0.432531, 0.437103, 0.441505, 0.445737, 0.449802, 0.453699, 0.457432, 0.461001, 0.464409, 0.467656, 0.470746, 0.47368, 0.476461, 0.479091, 0.481572};
        
        WHEN("The sine wave is processed") {
            mProcessor.prepareToPlay(sampleRate, mSampleBuffer.getNumSamples());
            MidiBuffer mMidiBuffer;
            mProcessor.processBlock(mSampleBuffer, mMidiBuffer);
            THEN("The output is as expected") {
                const float* readPointer1 {mSampleBuffer.getReadPointer(0)};
                const float* readPointer2 {mSampleBuffer.getReadPointer(1)};
                
                for (int iii {}; iii < mSampleBuffer.getNumSamples(); iii++) {
                    REQUIRE(CoreTestLib::compareFloats(readPointer1[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                    REQUIRE(CoreTestLib::compareFloats(readPointer2[iii], expectedOutput[iii], CoreTestLib::HIGHER_TOLERANCE));
                }
            }
        }
    }
}


